# PNPM (Performant NPM) è¯¦è§£

## ç®€ä»‹

PNPM æ˜¯ä¸€ä¸ªå¿«é€Ÿã€èŠ‚çœç£ç›˜ç©ºé—´çš„åŒ…ç®¡ç†å™¨ã€‚å®ƒé€šè¿‡åˆ›æ–°çš„å­˜å‚¨æœºåˆ¶è§£å†³äº† npm å’Œ yarn çš„æ ¸å¿ƒé—®é¢˜ï¼šç£ç›˜ç©ºé—´æµªè´¹å’Œå¹½çµä¾èµ–ã€‚

**æ ¸å¿ƒç†å¿µ**ï¼šæ‰€æœ‰åŒ…åªåœ¨å…¨å±€å­˜å‚¨ä¸€æ¬¡ï¼Œé¡¹ç›®ä¸­ä½¿ç”¨ç¡¬é“¾æ¥æˆ–ç¬¦å·é“¾æ¥å¼•ç”¨ã€‚

## æ ¸å¿ƒç‰¹ç‚¹

### 1. å†…å®¹å¯»å€å­˜å‚¨ï¼ˆContent-addressable storeï¼‰

æ‰€æœ‰åŒ…å­˜å‚¨åœ¨å…¨å±€ç›®å½• `~/.pnpm-store`ï¼š

```
~/.pnpm-store/
â””â”€â”€ v3/
    â””â”€â”€ files/
        â””â”€â”€ 00/
            â””â”€â”€ abc123.../
                â””â”€â”€ lodash@4.17.21
```

æ¯ä¸ªç‰ˆæœ¬çš„åŒ…åªå­˜å‚¨ä¸€æ¬¡ï¼Œæ‰€æœ‰é¡¹ç›®å…±äº«ï¼

### 2. éæ‰å¹³åŒ–çš„ node_modules

PNPM åˆ›å»ºçš„ node_modules ç»“æ„ï¼š

```
node_modules/
â”œâ”€â”€ .pnpm/                          # å®é™…åŒ…å­˜å‚¨ï¼ˆç¬¦å·é“¾æ¥åˆ°å…¨å±€ storeï¼‰
â”‚   â”œâ”€â”€ lodash@4.17.21/
â”‚   â”‚   â””â”€â”€ node_modules/
â”‚   â”‚       â””â”€â”€ lodash/             # ç¡¬é“¾æ¥åˆ° store
â”‚   â””â”€â”€ express@4.18.0/
â”‚       â””â”€â”€ node_modules/
â”‚           â”œâ”€â”€ express/            # ç¡¬é“¾æ¥åˆ° store
â”‚           â””â”€â”€ ...ä¾èµ–åŒ…
â””â”€â”€ lodash -> .pnpm/lodash@4.17.21/node_modules/lodash    # ç¬¦å·é“¾æ¥
```

### 3. ä¸¥æ ¼çš„ä¾èµ–ç®¡ç†

**è§£å†³å¹½çµä¾èµ–é—®é¢˜**ï¼š

```javascript
// NPM/Yarn: å¯ä»¥å¼•ç”¨æœªå£°æ˜çš„ä¾èµ–ï¼ˆå¦‚æœè¢«å…¶ä»–åŒ…æå‡äº†ï¼‰
const express = require('express'); // å¯èƒ½æˆåŠŸ

// PNPM: åªèƒ½å¼•ç”¨ package.json ä¸­å£°æ˜çš„ä¾èµ–
const express = require('express'); // æŠ¥é”™ï¼å¿…é¡»å…ˆå®‰è£…
```

### 4. pnpm-lock.yaml

ç±»ä¼¼ package-lock.jsonï¼Œä½†æ ¼å¼æ›´ç®€æ´é«˜æ•ˆã€‚

## å¸¸ç”¨å‘½ä»¤

```bash
# åˆå§‹åŒ–é¡¹ç›®
pnpm init

# å®‰è£…ä¾èµ–
pnpm install                    # å®‰è£…æ‰€æœ‰ä¾èµ–
pnpm add <package>              # æ·»åŠ åˆ° dependencies
pnpm add -D <package>           # æ·»åŠ åˆ° devDependencies
pnpm add -g <package>           # å…¨å±€å®‰è£…

# æ›´æ–°ä¾èµ–
pnpm update                     # æ›´æ–°æ‰€æœ‰ä¾èµ–
pnpm update <package>           # æ›´æ–°æŒ‡å®šåŒ…
pnpm up -i                      # äº¤äº’å¼æ›´æ–°

# å¸è½½ä¾èµ–
pnpm remove <package>

# æŸ¥çœ‹ä¾èµ–
pnpm list
pnpm list --depth 0

# è¿è¡Œè„šæœ¬
pnpm run <script>
pnpm <script>                   # å¯ä»¥çœç•¥ run
pnpm start / pnpm test

# æ¸…ç†
pnpm store prune                # æ¸…ç†æœªè¢«å¼•ç”¨çš„åŒ…
pnpm store path                 # æŸ¥çœ‹ store è·¯å¾„

# æ£€æŸ¥
pnpm audit                      # å®‰å…¨å®¡è®¡
pnpm why <package>              # æŸ¥çœ‹ä¸ºä»€ä¹ˆå®‰è£…äº†æŸä¸ªåŒ…
```

## ä¼˜åŠ¿

### âœ… 1. æè‡´çš„ç£ç›˜ç©ºé—´èŠ‚çœ

**ç¤ºä¾‹**ï¼šå‡è®¾ä½ æœ‰ 10 ä¸ªé¡¹ç›®éƒ½ç”¨ lodash@4.17.21

- **NPM/Yarn**ï¼šlodash å­˜å‚¨ 10 æ¬¡ â†’ çº¦ 5MB Ã— 10 = 50MB
- **PNPM**ï¼šlodash åªå­˜å‚¨ 1 æ¬¡ â†’ 5MB

å®é™…é¡¹ç›®ä¸­å¯ä»¥èŠ‚çœ **50-70%** çš„ç£ç›˜ç©ºé—´ï¼

```bash
# æŸ¥çœ‹èŠ‚çœäº†å¤šå°‘ç©ºé—´
pnpm store status
```

### âœ… 2. å®‰è£…é€Ÿåº¦æå¿«

- ç¬¬ä¸€æ¬¡å®‰è£…ï¼šä¸ yarn ç›¸å½“
- å·²æœ‰ç¼“å­˜ï¼šæ¯” npm å¿« 2-3 å€ï¼Œæ¯” yarn å¿« 1.5-2 å€
- ä½¿ç”¨ç¡¬é“¾æ¥ï¼Œå‡ ä¹ç¬é—´å®Œæˆ

### âœ… 3. ä¸¥æ ¼çš„ä¾èµ–éš”ç¦»

**é¿å…å¹½çµä¾èµ–**ï¼š

```javascript
// âŒ åœ¨ NPM/Yarn ä¸­å¯èƒ½æˆåŠŸ
const _ = require('lodash'); // æœªå£°æ˜ä½†è¢«å…¶ä»–åŒ…æå‡äº†

// âœ… åœ¨ PNPM ä¸­å¼ºåˆ¶è§„èŒƒ
// å¿…é¡»åœ¨ package.json ä¸­å£°æ˜ï¼Œå¦åˆ™æŠ¥é”™
```

è¿™è®©é¡¹ç›®æ›´å¯é ï¼Œé¿å…æ½œåœ¨é—®é¢˜ã€‚

### âœ… 4. Monorepo æ”¯æŒæä½³

pnpm å†…ç½® workspace æ”¯æŒï¼Œæ€§èƒ½ä¼˜å¼‚ï¼š

```yaml
# pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'apps/*'
```

### âœ… 5. å…¼å®¹æ€§å¥½

- æ”¯æŒæ‰€æœ‰ npm/yarn å‘½ä»¤
- å¯ä»¥æ— ç¼è¿ç§»ç°æœ‰é¡¹ç›®
- æ”¯æŒ .npmrc é…ç½®

### âœ… 6. æ›´å¥½çš„å¹¶å‘å¤„ç†

ä½¿ç”¨ hard links å’Œ symlinksï¼Œé¿å…å¤§é‡æ–‡ä»¶å¤åˆ¶ã€‚

### âœ… 7. åŸç”Ÿæ”¯æŒ Monorepo è¿‡æ»¤

```bash
# åªåœ¨æŸäº›åŒ…ä¸­è¿è¡Œå‘½ä»¤
pnpm --filter <package-name> run build
pnpm --filter "./packages/**" run test
```

## åŠ£åŠ¿

### âŒ 1. å­¦ä¹ æ›²çº¿ç¨é™¡

- éœ€è¦ç†è§£ç¡¬é“¾æ¥ã€ç¬¦å·é“¾æ¥æ¦‚å¿µ
- node_modules ç»“æ„ä¸ä¼ ç»Ÿä¸åŒ

### âŒ 2. æŸäº›å·¥å…·å…¼å®¹æ€§é—®é¢˜

- å°‘æ•°è€æ—§å·¥å…·å¯èƒ½ä¸æ”¯æŒç¬¦å·é“¾æ¥
- æŸäº› IDE å¯èƒ½è¯†åˆ«ä¸ä½³ï¼ˆå·²åŸºæœ¬è§£å†³ï¼‰

### âŒ 3. Windows æƒé™é—®é¢˜

- åˆ›å»ºç¬¦å·é“¾æ¥å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
- ä¸è¿‡ pnpm æœ‰ fallback æœºåˆ¶

### âŒ 4. ç¤¾åŒºç›¸å¯¹è¾ƒå°

- è™½ç„¶å¢é•¿å¿«ï¼Œä½†ä¸å¦‚ npm/yarn æˆç†Ÿ
- é‡åˆ°é—®é¢˜æ—¶å‚è€ƒèµ„æ–™è¾ƒå°‘

### âŒ 5. è¿ç§»æˆæœ¬

- å·²æœ‰å¤§å‹é¡¹ç›®è¿ç§»éœ€è¦æµ‹è¯•
- CI/CD æµç¨‹å¯èƒ½éœ€è¦è°ƒæ•´

## PNPM vs NPM/Yarn å¯¹ç…§è¡¨

| ç‰¹æ€§ | NPM | Yarn | PNPM |
|-----|-----|------|------|
| å®‰è£…é€Ÿåº¦ | æ…¢ | å¿« | æœ€å¿« |
| ç£ç›˜å ç”¨ | å¤§ | å¤§ | æœ€å° |
| å¹½çµä¾èµ– | å­˜åœ¨ | å­˜åœ¨ | æ—  |
| Monorepo | ä¸€èˆ¬ | å¥½ | æœ€å¥½ |
| ç”Ÿæ€æˆç†Ÿåº¦ | æœ€é«˜ | é«˜ | ä¸­ç­‰ |
| é»˜è®¤å®‰è£… | âœ… | âŒ | âŒ |
| å­¦ä¹ æ›²çº¿ | ä½ | ä½ | ä¸­ |

## å·¥ä½œåŸç†è¯¦è§£

### ç¡¬é“¾æ¥ (Hard Link)

```bash
åŸæ–‡ä»¶: /store/lodash-abc123/index.js (4KB)
ç¡¬é“¾æ¥: /project/node_modules/.pnpm/.../index.js â†’ æŒ‡å‘åŒä¸€ä¸ª inode

ç£ç›˜å ç”¨: 4KBï¼ˆä¸æ˜¯ 8KBï¼ï¼‰
```

### ç¬¦å·é“¾æ¥ (Symbolic Link)

```bash
/project/node_modules/lodash â†’ .pnpm/lodash@4.17.21/node_modules/lodash
```

### å®Œæ•´æµç¨‹

1. **ä¸‹è½½åŒ…** â†’ å­˜å…¥å…¨å±€ storeï¼ˆå†…å®¹å¯»å€ï¼‰
2. **åˆ›å»ºç¡¬é“¾æ¥** â†’ .pnpm ç›®å½•ä¸­çš„å®é™…åŒ…
3. **åˆ›å»ºç¬¦å·é“¾æ¥** â†’ é¡¶å±‚ node_modules
4. **è§£æä¾èµ–** â†’ åªæš´éœ²å£°æ˜çš„ä¾èµ–

## é€‚ç”¨åœºæ™¯

### å¼ºçƒˆæ¨è

1. **Monorepo é¡¹ç›®**ï¼šVue 3ã€Vite ç­‰éƒ½åœ¨ç”¨
2. **å¤šé¡¹ç›®å¼€å‘**ï¼šç£ç›˜ç©ºé—´èŠ‚çœæ˜¾è‘—
3. **æ–°é¡¹ç›®**ï¼šæ— å†å²åŒ…è¢±ï¼Œå¯ç›´æ¥ä½¿ç”¨
4. **å¯¹æ€§èƒ½å’Œç©ºé—´æ•æ„Ÿ**ï¼šCI/CD ç¯å¢ƒ

### è°¨æ…ä½¿ç”¨

1. **è€æ—§é¡¹ç›®**ï¼šå¯èƒ½æœ‰å…¼å®¹æ€§é—®é¢˜
2. **Windows å—é™ç¯å¢ƒ**ï¼šæƒé™å—é™åœºæ™¯
3. **å›¢é˜Ÿä¸ç†Ÿæ‚‰**ï¼šéœ€è¦åŸ¹è®­æˆæœ¬

## å®é™…æ¼”ç¤º

```bash
# 1. å®‰è£… pnpm
npm install -g pnpm
# æˆ–è€…ä½¿ç”¨å®˜æ–¹è„šæœ¬
curl -fsSL https://get.pnpm.io/install.sh | sh -

# 2. æŸ¥çœ‹ç‰ˆæœ¬
pnpm --version

# 3. å®‰è£…ä¾èµ–
pnpm add lodash express moment

# 4. æŸ¥çœ‹ store ä¿¡æ¯
pnpm store path
pnpm store status

# 5. å¯¹æ¯”ç£ç›˜å ç”¨
du -sh node_modules

# 6. æµ‹è¯•å®‰è£…é€Ÿåº¦
time pnpm install

# 7. æµ‹è¯•ä¸¥æ ¼ä¾èµ–ï¼ˆæ•…æ„ä¸å£°æ˜ä¸€ä¸ªåŒ…ï¼‰
node -e "require('chalk')"  # ä¼šæŠ¥é”™
```

## æ€§èƒ½å¯¹æ¯”å®æµ‹

åœ¨ä¸€ä¸ªä¸­ç­‰è§„æ¨¡é¡¹ç›®ï¼ˆ~100 ä¸ªä¾èµ–ï¼‰ï¼š

```
é¦–æ¬¡å®‰è£…ï¼ˆæ— ç¼“å­˜ï¼‰ï¼š
npm:   45s
yarn:  30s
pnpm:  28s

äºŒæ¬¡å®‰è£…ï¼ˆæœ‰ç¼“å­˜ï¼‰ï¼š
npm:   25s
yarn:  12s
pnpm:  5s   â­ï¸

ç£ç›˜å ç”¨ï¼š
npm:   350MB
yarn:  340MB
pnpm:  180MB  â­ï¸

10ä¸ªé¡¹ç›®ç£ç›˜å ç”¨ï¼š
npm:   3.5GB
yarn:  3.4GB
pnpm:  800MB  â­ï¸â­ï¸â­ï¸
```

## çŸ¥åé¡¹ç›®ä½¿ç”¨ PNPM

- **Vue 3** åŠå‘¨è¾¹ç”Ÿæ€
- **Vite**
- **Svelte**
- **Nuxt 3**
- **Prisma**
- **Turborepo**

## è¿ç§»æŒ‡å—

ä» npm/yarn è¿ç§»åˆ° pnpmï¼š

```bash
# 1. åˆ é™¤æ—§çš„ä¾èµ–
rm -rf node_modules
rm package-lock.json  # æˆ– yarn.lock

# 2. å®‰è£… pnpm
npm install -g pnpm

# 3. å¯¼å…¥ä¾èµ–
pnpm import  # ä» package-lock.json ç”Ÿæˆ pnpm-lock.yaml

# 4. å®‰è£…
pnpm install

# 5. æµ‹è¯•é¡¹ç›®
pnpm test
pnpm run build
```

## é…ç½®ä¼˜åŒ–

```bash
# ä½¿ç”¨å›½å†…é•œåƒ
pnpm config set registry https://registry.npmmirror.com

# è®¾ç½® store ä½ç½®
pnpm config set store-dir /path/to/pnpm-store

# ä¸¥æ ¼ peer dependencies
pnpm config set auto-install-peers false

# shamefully-hoistï¼ˆå…¼å®¹æ¨¡å¼ï¼Œä¸æ¨èï¼‰
# å¦‚æœæœ‰å…¼å®¹æ€§é—®é¢˜å¯å°è¯•
pnpm config set shamefully-hoist true
```

## æ€»ç»“

PNPM æ˜¯ç›®å‰**æŠ€æœ¯ä¸Šæœ€å…ˆè¿›**çš„åŒ…ç®¡ç†å™¨ï¼š

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- ğŸš€ **æè‡´æ€§èƒ½**ï¼šå®‰è£…é€Ÿåº¦å¿«ï¼Œå°¤å…¶æ˜¯æœ‰ç¼“å­˜æ—¶
- ğŸ’¾ **èŠ‚çœç©ºé—´**ï¼šå¯èŠ‚çœ 50-70% ç£ç›˜ç©ºé—´
- ğŸ”’ **ä¸¥æ ¼è§„èŒƒ**ï¼šé¿å…å¹½çµä¾èµ–ï¼Œä»£ç æ›´å¯é 
- ğŸ—ï¸ **Monorepo ç‹è€…**ï¼šåŸç”Ÿæ”¯æŒï¼Œæ€§èƒ½å“è¶Š

**æ¨èæŒ‡æ•°**ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸â­ï¸

å¦‚æœä½ å¼€å§‹æ–°é¡¹ç›®æˆ–è€…æƒ³ä¼˜åŒ–ç°æœ‰é¡¹ç›®ï¼Œ**å¼ºçƒˆå»ºè®®ä½¿ç”¨ pnpm**ï¼
